<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View RSVPs</title>
    <link rel="stylesheet" href="stylesheets/base.css">
    <link rel="stylesheet" href="stylesheets/calendar.css">
    <link rel="stylesheet" href="stylesheets/management.css">
</head>

<body>
    <div class="main-container">
        <div class="sidebar">
            <h3>Filter by Branch:</h3>
            <ul id="branchList">
                <!-- Branches will be populated here by JavaScript -->
            </ul>
        </div>

        <div class="events-section">
            <h2>Events</h2>
            <div id="eventsList">
                <!-- Events will be populated here by JavaScript -->
            </div>
        </div>

        <div class="rsvps-section">
            <h2>RSVPs for Events</h2>
            <div id="rsvpsList">
                <!-- RSVPs will be populated here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Function to fetch branches of a specific organization
        async function fetchBranches(organizationId) {
            try {
                // Fetch branches data from the server endpoint specific to the organization
                const response = await fetch(`/userevents/organization/${organizationId}/branches`);

                // Handle error responses
                if (!response.ok) {
                    console.error('Error fetching branches:', response.statusText);
                    return;
                }

                // Parse the JSON response body to get the branches data
                const branches = await response.json();

                // Get the branch list element where branches will be displayed
                const branchList = document.getElementById('branchList');
                branchList.innerHTML = '';

                // Iterate over each branch and create a checkbox with label
                branches.forEach(branch => {
                    const li = document.createElement('li'); // Create a list item for each branch
                    const input = document.createElement('input'); // Create an input element (checkbox)
                    input.type = 'checkbox'; // Set input type to checkbox
                    input.id = branch.id; // Set input id to branch id
                    input.onchange = () => {
                        fetchEvents(organizationId); // Fetch events when checkbox state changes
                        fetchRSVPs(0, organizationId, 0); // Fetch RSVPs with default parameters
                    };

                    const label = document.createElement('label'); // Create a label element
                    label.htmlFor = branch.id; // Associate label with input using id
                    label.textContent = branch.location; // Set label text to branch location

                    li.appendChild(input); // Append input to list item
                    li.appendChild(label); // Append label to list item
                    branchList.appendChild(li); // Append list item to branch list
                });
            } catch (error) {
                console.error('Error fetching branches:', error); // Log any errors that occur during fetching or processing
            }
        }

        // Function to fetch events based on selected branch or organization
        async function fetchEvents(organizationId) {
            // Get the id of the selected branch checkbox
            const selectedBranchId = document.querySelector('#branchList input[type="checkbox"]:checked')?.id;
            let url = `/userevents/organization/${organizationId}/events`;

            // Adjust URL based on whether a branch is selected
            if (selectedBranchId) {
                url = `/userevents/branch/${selectedBranchId}/events`;
            }

            try {
                // Fetch events data from the determined URL
                const response = await fetch(url);

                // Handle error responses
                if (!response.ok) {
                    console.error('Error fetching events:', response.statusText);
                    return;
                }

                // Parse the JSON response body to get the events data
                const events = await response.json();

                // Get the events list element where events will be displayed
                const eventsList = document.getElementById('eventsList');
                eventsList.innerHTML = '';

                // Iterate over each event and create a clickable div with event details
                events.forEach(event => {
                    const eventDiv = document.createElement('div'); // Create a div for each event
                    eventDiv.classList.add('events-update'); // Add a class for styling
                    eventDiv.onclick = () => {
                        document.querySelectorAll('.events-update').forEach(div => div.classList.remove('active'));
                        eventDiv.classList.add('active');
                        fetchRSVPs(event.id, organizationId, selectedBranchId); // Fetch RSVPs for the clicked event
                    };

                    const updateTextDiv = document.createElement('div'); // Create a div for event details
                    updateTextDiv.classList.add('update-text'); // Add a class for styling
                    updateTextDiv.innerHTML = `
                        <h3>${event.date} & ${event.name}</h3>
                        <p>${event.description}</p>
                    `;

                    eventDiv.appendChild(updateTextDiv); // Append details div to event div
                    eventsList.appendChild(eventDiv); // Append event div to events list
                });
            } catch (error) {
                console.error('Error fetching events:', error); // Log any errors that occur during fetching or processing
            }
        }

        // Function to fetch RSVPs for a specific event, organization, and branch
        async function fetchRSVPs(eventId, organizationId, branchId) {
            try {
                // Construct URL for fetching RSVPs based on event, organization, and branch
                const url = `/userevents/organization/${organizationId}/branch/${branchId}/event/${eventId}/rsvps`;
                const response = await fetch(url);

                // Handle unauthorized (401) and forbidden (403) responses
                if (response.status === 401) {
                    alert('You need to be logged in to view RSVPs.');
                    window.location.href = '/login'; // Redirect to login page if not logged in
                    return;
                } else if (response.status === 403) {
                    alert('You do not have permission to view this information.');
                    return;
                }

                // Parse the JSON response body to get the RSVPs data
                const rsvps = await response.json();

                // Get the RSVPs list element where RSVPs will be displayed
                const rsvpsList = document.getElementById('rsvpsList');
                rsvpsList.innerHTML = '';

                // Create a div to display total RSVP count
                const rsvpCount = document.createElement('div');
                rsvpCount.classList.add('rsvp-count');
                rsvpCount.textContent = `Total RSVPs: ${rsvps.length}`;
                rsvpsList.appendChild(rsvpCount); // Append total count div to RSVPs list

                // Iterate over each RSVP and create a div with RSVP details
                rsvps.forEach(rsvp => {
                    const rsvpDiv = document.createElement('div'); // Create a div for each RSVP
                    rsvpDiv.classList.add('rsvp-update'); // Add a class for styling
                    rsvpDiv.innerHTML = `
                        <p>${rsvp.first_name} ${rsvp.last_name} (${rsvp.email})</p>
                    `;
                    rsvpsList.appendChild(rsvpDiv); // Append RSVP div to RSVPs list
                });
            } catch (error) {
                console.error('Error fetching RSVPs:', error); // Log any errors that occur during fetching or processing
            }
        }

        // Event listener for when the DOM content is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const organizationId = urlParams.get('organizationId'); // Get organization ID from URL params

            // Fetch branches and events for the organization once DOM is loaded
            if (organizationId) {
                fetchBranches(organizationId);
                fetchEvents(organizationId);
            }
        });
    </script>

</body>

</html>
