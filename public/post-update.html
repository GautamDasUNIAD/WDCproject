<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Update</title>
    <link rel="stylesheet" href="stylesheets/base.css">
    <link rel="stylesheet" href="stylesheets/management.css">
</head>

<body>
    <div class="main-container">
        <div class="post-update-section">
            <h2 style = "text-align: center; font-size: 25px;text-decoration: underline;">Post an Update</h2>
            <form id="postUpdateForm">
                <label for="organization">Organization:</label>
                <select id="organization" name="organization" required></select>

                <label for="title">Title:</label>
                <input type="text" id="title" name="title" required>

                <label for="description">Description:</label>
                <textarea id="description" name="description" required rows = "4" cols = "50"></textarea>

                <label for="is_private">Private:
                    <input type="checkbox" id="is_private" name="is_private">
                </label>




                <input type="submit" value="Post Update">
            </form>
            <div id="responseMessage"></div>
        </div>
    </div>

    <script>
        // Function to fetch manager's organizations and populate select dropdown
        async function fetchManagerOrganizations() {
            try {
                const response = await fetch('/updates/manager/organizations');
                const organizations = await response.json(); // Parse JSON response

                const orgSelect = document.getElementById('organization'); // Select dropdown element
                organizations.forEach(org => {
                    const option = document.createElement('option'); // Create option element
                    option.value = org.id; // Set option value to organization ID
                    option.textContent = org.name; // Set option text to organization name
                    orgSelect.appendChild(option); // Append option to select dropdown
                });
            } catch (error) {
                console.error('Error fetching organizations:', error); // Log error if fetch fails
            }
        }

        // Function to handle form submission for posting updates
        async function postUpdate(event) {
            event.preventDefault(); // Prevent default form submission behavior

            // Retrieve form data
            const organizationId = document.getElementById('organization').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const is_private = document.getElementById('is_private').checked;

            try {
                // Send POST request to server to post update
                const response = await fetch(`/updates/organization/${organizationId}/updates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, description, is_private })
                });

                const message = await response.text(); // Get response message text

                // Display response message
                document.getElementById('responseMessage').textContent = message;

                // Handle different HTTP status codes
                if (response.status === 401) {
                    alert('You need to be logged in to post updates.'); // Alert if user is not logged in
                    window.location.href = '/login'; // Redirect to login page
                    return;
                } else if (response.status === 403) {
                    alert('You do not have permission to post updates.'); // Alert if permission denied
                    return;
                }
            } catch (error) {
                console.error('Error posting update:', error); // Log error if posting update fails
            }
        }

        // Event listener for form submission to post update
        document.getElementById('postUpdateForm').addEventListener('submit', postUpdate);

        // Event listener when DOM content is loaded to fetch manager's organizations
        document.addEventListener('DOMContentLoaded', fetchManagerOrganizations);
    </script>

</body>

</html>
