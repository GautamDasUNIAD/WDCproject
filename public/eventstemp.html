<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events</title>
    <link rel="stylesheet" href="stylesheets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <nav>
        <ul>
            <li><a class="active" href="/home">LOGO</a></li>
            <li><a href="/events">Events</a></li>
            <li><a href="/branches">Branches</a></li>
        </ul>
        <form class="search-form" action="/search" method="GET">
            <input type="text" name="q" placeholder="Search...">
            <button type="submit"><i class="fa fa-search"></i></button>
        </form>
        <ul>
            <li><a href="/login" class="button2">Login</a></li>
            <li><a href="/signup" class="button3">Signup</a></li>
        </ul>
    </nav>

    <div class="main-container">
        <div class="sidebar">
            <p><a class="active" href="/home">Home </a> / <a href="/events">Events</a></p>
            <div class="view-buttons">
                <button type="button" class="view-button active" onclick="showListView()">List View</button>
                <button type="button" class="view-button" onclick="showCalendarView()">Calendar View</button>
            </div>
            <h3>Sort by Branch:</h3>
            <ul id="branchList">
                <!-- Branches will be populated here by JavaScript -->
            </ul>
        </div>
    </div>

    <div class="accessibility-button" onclick="toggleAccessibility()">
        <i class="fas fa-eye"></i>
    </div>

    <div class="events-section">
        <h2>Key Events</h2>
        <div id="eventsList">
            <!-- Events will be populated here by JavaScript -->
        </div>
        <div class="button-container">
            <button type="button" class="read-more-button">Read More</button>
        </div>
    </div>

    <div id="organizationList"></div>


    <footer>
        <div class="footer-content">
            <div class="social-media-links">
                <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.youtube.com" target="_blank"><i class="fab fa-youtube"></i></a>
                <a href="https://www.tiktok.com" target="_blank"><i class="fab fa-tiktok"></i></a>
            </div>
            <div class="footer-logo">
                <img src="logo.png" alt="Company Logo">
            </div>
            <div class="footer-links">
                <a href="/about">About Us</a>
                <a href="/contact">Contact Us</a>
            </div>
        </div>
    </footer>

    <button type="button" id="scrollToTopBtn" title="Go to top">â†‘ Top</button>

    <script src="javascripts/scrollbutton.js"></script>
    <script>
        async function fetchMyOrganizations() {
            try {
                const response = await fetch('/userevents/myorganizations');
                console.log('waiting');
                if (response.status === 401) {
                    alert('You need to be logged in to view organizations.');
                    window.location.href = '/login';
                    return;
                }

                const organizations = await response.json();
                if (organizations.length === 0) {
                    alert('You are not part of any organizations. Please join an organization first.');
                    window.location.href = '/join-organization';
                    return;
                }

                const orgList = document.getElementById('organizationList');
                orgList.innerText = '';
                organizations.forEach(org => {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = `/eventstemp.html?organizationId=${org.id}`;
                    a.textContent = org.name;
                    li.appendChild(a);
                    orgList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching organizations:', error);
            }
        }

        async function fetchEvents(organizationId, branchId) {
            let url = `/userevents/organization/${organizationId}/events`;
            if (branchId) {
                url = `/userevents/branch/${branchId}/events`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('Error fetching events:', response.statusText);
                    return;
                }

                const events = await response.json();
                const eventsList = document.getElementById('eventsList');
                eventsList.innerText = '';

                events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.classList.add('events-update');

                    const voteDiv = document.createElement('div');
                    voteDiv.classList.add('vote');
                    voteDiv.innerText = `
                        <div class="upvote">
                            <button type="button" class="vote-button" onclick="upvote()">+</button>
                        </div>
                        <hr>
                        <div class="downvote">
                            <button type="button" class="vote-button" onclick="downvote()">-</button>
                        </div>
                    `;

                    const updateTextDiv = document.createElement('div');
                    updateTextDiv.classList.add('update-text');
                    updateTextDiv.innerText = `
                        <h3>${event.date} & ${event.name}</h3>
                        <p>${event.description}</p>
                        <button type="button" onclick="rsvpForEvent(${event.id})">RSVP</button>
                    `;

                    eventDiv.appendChild(voteDiv);
                    eventDiv.appendChild(updateTextDiv);
                    eventsList.appendChild(eventDiv);
                });
            } catch (error) {
                console.error('Error fetching events:', error);
            }
        }

        async function fetchBranches(organizationId) {
            try {
                const response = await fetch(`/userevents/organization/${organizationId}/branches`);
                if (!response.ok) {
                    console.error('Error fetching branches:', response.statusText);
                    return;
                }

                const branches = await response.json();
                const branchList = document.getElementById('branchList');
                branchList.innerText = '';

                branches.forEach(branch => {
                    const li = document.createElement('li');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = branch.id;
                    input.onchange = () => {
                        if (input.checked) {
                            fetchEvents(organizationId, branch.id);
                        } else {
                            fetchEvents(organizationId);
                        }
                    };

                    const label = document.createElement('label');
                    label.htmlFor = branch.id;
                    label.textContent = branch.location;

                    li.appendChild(input);
                    li.appendChild(label);
                    branchList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching branches:', error);
            }
        }

        async function rsvpForEvent(eventId) {
            try {
                const response = await fetch('/userevents/rsvp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ eventId })
                });

                if (response.status === 401) {
                    alert('You need to be logged in to RSVP for events.');
                    window.location.href = '/login';
                    return;
                }

                const message = await response.text();
                alert(message);
            } catch (error) {
                console.error('Error RSVPing for event:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const organizationId = urlParams.get('organizationId');
            fetchEvents(organizationId);
            fetchBranches(organizationId);
            fetchMyOrganizations();
        });
    </script>
</body>

</html>